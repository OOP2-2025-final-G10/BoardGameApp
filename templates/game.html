<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>人生ゲーム - プレイ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
</head>

<body class="game-page">
    <div class="game-container">

        <div class="game-main">
            <div class="map-area box-border">
                マップ
                <div class="zoom-btns">
                    <button>+</button>
                    <button>-</button>
                </div>
            </div>

            <div class="bottom-area">
                <div class="roulette-container box-border">
                    <div class="roulette-wrapper">
                        <img id="roulette" src="{{ url_for('static', filename='roulette.png') }}" alt="roulette">
                        <div class="roulette-pointer"></div>
                    </div>
                    <button id="spinBtn" class="roulette-circle {% if not is_my_turn %}disabled{% endif %}" {% if not
                        is_my_turn %}disabled{% endif %} data-is-my-turn="{{ 1 if is_my_turn else 0 }}">
                        まわす
                    </button>

                </div>
                <div class="game-logo box-border">人生ゲーム</div>
            </div>
        </div>

        <aside class="info-sidebar box-border">
            <details>
                <summary>ユーザー</summary>
                <ul id="userList"></ul>
            </details>
            <details>
                <summary>株式売買</summary>
                <p>購入、または売却したい銘柄と数量を指定してください。売却の際に-1を入力すると全株を売却できます。</p>
                <select id="stockName">
                    <option value="STOCK_A">STOCK_A</option>
                    <option value="STOCK_B">STOCK_B</option>
                    <option value="STOCK_C">STOCK_C</option>
                    <option value="STOCK_D">STOCK_D</option>
                    <option value="STOCK_E">STOCK_E</option>
                </select>
                <input type="number" id="stockAmount" value="1" min="1">
                <button onclick="buyStock()">購入</button>
                <button onclick="sellStock()">売却</button>
                <div id="tradeResult"></div>
            </details>
            <details>
                <div class="box-border">
                    <h3>株価推移</h3>
                    <canvas id="stockChart" width="400" height="200"></canvas>
                </div>
            </details>

            <ul class="status-info">
                <li>ユーザー：</li>
                <li>・ ゴールまでの距離：</li>
                <li>・ 職業：</li>
                <li>・ 所持金：</li>
                <li>・ 配偶者の有無：</li>
                <li>・ 子供の数：</li>
                <li>・ 持ち株：</li>
            </ul>
        </aside>
    </div>
    <script>

        const wheel = document.getElementById("roulette");
        const btn = document.getElementById("spinBtn");

        let myUserId = "{{ user.user_id }}";
        let isMyTurn = btn.dataset.isMyTurn === "1";
        let isSpinning = false;
        let currentViewingUserId = null;

        const userList = document.getElementById("userList");
        const statusItems = document.querySelectorAll(".status-info li");

        updateSpinButton(isMyTurn);

        btn.onclick = () => {
            if (isSpinning) return;

            isSpinning = true;
            updateSpinButton(false);

            const es = new EventSource("/roulette/stream");

            es.onmessage = (e) => {
                if (e.data.startsWith("RESULT")) {
                    es.close();
                    isSpinning = false;

                    syncCurrentUserStatus();
                    return;
                }

                wheel.style.transform = `rotate(${parseFloat(e.data)}deg)`;
            };
        };


        function loadUsers() {
            fetch("/api/users")
                .then(res => res.json())
                .then(data => {
                    userList.innerHTML = "";
                    data.users.forEach(u => {
                        const li = document.createElement("li");
                        const btn = document.createElement("button");
                        btn.textContent = u.name;
                        btn.className = "user-link";
                        btn.onclick = () => loadUserStatus(u.id);
                        li.appendChild(btn);
                        userList.appendChild(li);
                    });
                });
        }

        // 3秒ごとに同期
        setInterval(loadUsers, 3000);
        loadUsers();

        async function syncTurn() {
            const res = await fetch("/api/game_state");
            const state = await res.json();

            const nowMyTurn = state.turn_user_id === myUserId;
            updateSpinButton(nowMyTurn);
        }

        syncTurn();
        setInterval(syncTurn, 2000);

        function updateSpinButton(serverSaysMyTurn) {
            const enabled = serverSaysMyTurn && !isSpinning;
            btn.disabled = !enabled;
            btn.classList.toggle("disabled", !enabled);
        }

        updateSpinButton(isMyTurn);

        function loadUserStatus(userId) {
            currentViewingUserId = userId;

            fetch(`/api/user/${userId}`)
                .then(res => res.json())
                .then(user => renderUserStatus(user));
        }


        function renderUserStatus(user) {
            statusItems[1].textContent = `・ ゴールまでの距離：${user.spot_id}`;
            statusItems[0].textContent = `ユーザー：${user.name}`;
            statusItems[2].textContent = `・ 職業：${user.job?.name ?? "なし"}`;
            statusItems[3].textContent = `・ 所持金：${user.money}`;
            const holdings = user.holdings || {};

            if (Object.keys(holdings).length === 0) {
                statusItems[6].textContent = `・ 持ち株：なし`;
            } else {
                const list = Object.entries(holdings)
                    .map(([name, qty]) => `${name} ×${qty}`)
                    .join(" / ");
                statusItems[6].textContent = `・ 持ち株：${list}`;
            }
        }


        function syncCurrentUserStatus() {
            if (!currentViewingUserId) return;

            fetch(`/api/user/${currentViewingUserId}`)
                .then(res => res.json())
                .then(user => {
                    renderUserStatus(user);
                });
        }

        setInterval(syncCurrentUserStatus, 2000);

        window.addEventListener("load", () => {
            currentViewingUserId = myUserId;
            loadUserStatus(myUserId);
        });

        function buyStock() {
            const stock = document.getElementById("stockName").value;
            const amount = document.getElementById("stockAmount").value;

            fetch("/api/stock/buy", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stock_name: stock,
                    amount: amount
                })
            })

                .then(res => res.json())
                .then(result => {
                    document.getElementById("tradeResult").textContent =
                        result.purchased
                            ? `購入成功：${result.symbol} ×${result.qty}`
                            : `失敗：${result.reason}`;
                    syncCurrentUserStatus();
                });
        }

        function sellStock() {
            const stock = document.getElementById("stockName").value;
            const amount = document.getElementById("stockAmount").value;

            fetch("/api/stock/sell", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stock_name: stock,
                    amount: amount
                })
            })

                .then(res => res.json())
                .then(result => {
                    document.getElementById("tradeResult").textContent =
                        result.sold
                            ? `売却成功：${result.symbol} ×${result.qty}`
                            : `失敗：${result.reason}`;
                    syncCurrentUserStatus();
                });
        }

        let stockChart = null;

        async function loadStockChart() {
            const res = await fetch("/api/stock/prices");
            const data = await res.json();

            const ctx = document.getElementById("stockChart").getContext("2d");

            const datasets = Object.entries(data.prices).map(([name, prices]) => ({
                label: name,
                data: prices,
                borderWidth: 2,
                tension: 0.3
            }));

            if (stockChart) {
                stockChart.data.labels = data.days;
                stockChart.data.datasets = datasets;
                stockChart.update();
                return;
            }

            stockChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: data.days,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: "日数"
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: "株価"
                            }
                        }
                    }
                }
            });
        }
        setInterval(loadStockChart, 2000);
        loadStockChart();
    </script>
</body>

</html>